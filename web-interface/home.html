<!DOCTYPE html>
<html>
<head>
   <link rel="stylesheet" href="styles.css">
  <title>To-Do List App</title>
   <script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const token = localStorage.getItem('token');
  
  socket.emit('authenticate', token);
  
  socket.on('taskCreated', (data) => {
  console.log('Task created:', data.task);
  loadTasks(); // Reload without full page refresh
});

socket.on('taskToggled', (data) => {
  console.log('Task toggled:', data.task);
  loadTasks(); 
});

socket.on('taskDeleted', (data) => {
  console.log('Task deleted:', data.taskId);
  loadTasks();
});
</script>
</head>
<body>

<div id="userInfo"></div>
<div id="authRequired" style="display:none; text-align: center; padding: 50px;">
  <p>Please <a href="/login.html">log in</a> to add tasks.</p>
  <p>No account? Register <a href="/signup.html">here</a></p>
</div>

<div id="taskForm" style="display:none;">
<h1>To-Do List</h1>

<form id="addTaskForm">
  <input id="taskInput" placeholder="Enter task" required>
  <select id="categorySelect">
    <option value="">Select or enter category</option>
  </select>
  <input id="newCategoryInput" placeholder="New category (or existing)" style="display:none;">
  <button type="submit">Add Task</button>
</form>
<p id="taskMessage"></p>

<div id="categoriesContainer"></div>
</div>

<div id="shareModal">
  <div class="modal-content">
    <h3>Share Folder</h3>
    <p>Share with:</p>
    <select id="shareUserSelect">
      <option value="">Select a user</option>
    </select>
    <br><br>
    <button onclick="confirmShare()">Share</button>
    <button onclick="closeShareModal()">Cancel</button>  <!--Modals are the pop up banners "local host says" or confirmations -->
  </div>
</div>

<script>
  let allCategories = new Set();
  let categoryOwners = {}; // Track category owners for shared folders
  let currentShareCategory = null;
  let allUsers = [];

  // Load all users for sharing
  async function loadUsers() {
    try {
      const token = localStorage.getItem('token');
const response = await fetch('/api/users', {
  headers: { 'Authorization': `Bearer ${token}` }
});
      if (response.ok) {
        allUsers = await response.json();
      }
    } catch (error) {
      console.error('Error loading users:', error);
    }
  }

  function openShareModal(category) {
    currentShareCategory = category;
    const select = document.getElementById('shareUserSelect');
    select.innerHTML = '<option value="">Select a user</option>';
    
    allUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.username;
      select.appendChild(option);
    });
    
    document.getElementById('shareModal').style.display = 'block';
  }

  function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
    currentShareCategory = null;
  }

  async function confirmShare() {
    const userId = document.getElementById('shareUserSelect').value;
    
    if (!userId) {
      alert('Please select a user');
      return;
    }

    try {
      const token = localStorage.getItem('token');
const response = await fetch('/api/shares', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',//Tells server type of data being sent
          'Authorization': `Bearer ${token}` //Bearer is the type of token (JWT)
        },
        body: JSON.stringify({ //body - data being sent to server. Converts data to JSON string
          category: currentShareCategory, //category being shared and its value
          ownerId: categoryOwnerId //owner of the category and value
        })
      });

      if (response.ok) {
        alert('Folder shared successfully!');
        closeShareModal();
        loadTasks();
      } else {
        const result = await response.json();
        alert(result.message || 'Error sharing folder');
      }
    } catch (error) {
      console.error('Error sharing folder:', error);
      alert('Network error');
    }//Try-catch checks for code that might fail (try) and handles error if anything does fail (catch)
  }

  // Check if user is logged in
  async function checkUserLogin() {
    try {
      const token = localStorage.getItem('token');
const response = await fetch('/auth/user', {
  headers: { 'Authorization': `Bearer ${token}` }
});
      if (response.ok) {
        const user = await response.json();
        displayLoggedInUser(user.username);
        showTaskForm();
        loadUsers();
        loadTasks();
      } else {
        displayNotLoggedIn();
      }
    } catch (error) {
      console.error('Error checking user:', error);
      displayNotLoggedIn();
    }
  }

  function displayLoggedInUser(username) {
    const userInfo = document.getElementById('userInfo');
    userInfo.innerHTML = `<p>Welcome, <strong>${username}</strong> | <button onclick="logout()" style="padding: 5px 10px; cursor: pointer;">Logout</button></p>`;
  }

  function displayNotLoggedIn() {
    document.getElementById('authRequired').style.display = 'block';
    document.getElementById('taskForm').style.display = 'none';
  }

  function showTaskForm() {
    document.getElementById('taskForm').style.display = 'block';
    document.getElementById('authRequired').style.display = 'none';
  }

  async function logout() {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}

  // Load all tasks
  async function loadTasks() {
    try {
      const token = localStorage.getItem('token');
const response = await fetch('/api/tasks', {
  headers: { 'Authorization': `Bearer ${token}` }
});
      if (response.ok) {
        const tasksByCategory = await response.json();
        displayTasks(tasksByCategory);
      } else {
        console.error('Failed to load tasks');
      }
    } catch (error) {
      console.error('Error loading tasks:', error);
    }
  }

  // Display tasks organized by category
  function displayTasks(tasksByCategory) {
    allCategories.clear();
    categoryOwners = {}; // Reset category owners
    
    Object.keys(tasksByCategory).forEach(cat => {
      allCategories.add(cat);
      // Track owner for shared categories
      if (tasksByCategory[cat].tasks.length > 0) {
        categoryOwners[cat] = tasksByCategory[cat].tasks[0].userId;
      }
    });
    updateCategorySelect();

    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';

    Object.keys(tasksByCategory).sort().forEach(category => {
      const catData = tasksByCategory[category];
      const categoryDiv = document.createElement('div');
      categoryDiv.style.marginBottom = '30px';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'category-header';
      
      const titleSpan = document.createElement('span');
      titleSpan.className = 'category-title';
      titleSpan.innerHTML = `<h2>${category}</h2>`;
      
      if (catData.shared) {
        titleSpan.innerHTML += `<span class="shared-badge">Shared with you by ${catData.sharedBy}</span>`;
      }
      
      headerDiv.appendChild(titleSpan);
      
      // Only show share button for owner's categories
      if (!catData.shared) {
        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.textContent = 'Share';
        shareBtn.onclick = () => openShareModal(category);
        headerDiv.appendChild(shareBtn);
      }
      
      categoryDiv.appendChild(headerDiv);
      
      const taskList = document.createElement('ul');
      taskList.id = `list-${category}`;
      
      catData.tasks.forEach(task => {
  const li = document.createElement('li');
  const strikethrough = task.completed ? 'style="text-decoration: line-through; color: #999;"' : '';
  
  li.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" style="margin-right: 10px; cursor: pointer;"><span ${strikethrough}>"${task.task}"</span>
    <span style="font-size: 0.85em; color: #666; margin-left: 10px;">Created by: ${task.username} ${task.createdAt}</span> 
    <button onclick="deleteTask(${task.id})" style="margin-left: 10px; cursor: pointer; color: red;">Delete</button>${task.completed && task.completedBy ? `<br><span style="font-size: 0.85em; color: #666; margin-left: 40px;">Marked done by: ${task.completedBy} at ${new Date(task.completedAt).toLocaleString()}</span>` : ''}`;
  taskList.appendChild(li);
});
      
      categoryDiv.appendChild(taskList);
      container.appendChild(categoryDiv);
    });
  }

  function updateCategorySelect() {
    const select = document.getElementById('categorySelect');
    const defaultOption = select.options[0];
    select.innerHTML = '';
    select.appendChild(defaultOption);

    Array.from(allCategories).sort().forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      select.appendChild(option);
    });

    const customOption = document.createElement('option');
    customOption.value = '__custom__';
    customOption.textContent = '+ Create New Category';
    select.appendChild(customOption);
  }

  document.getElementById('categorySelect').addEventListener('change', (e) => {
    const newCategoryInput = document.getElementById('newCategoryInput');
    if (e.target.value === '__custom__') {
      newCategoryInput.style.display = 'block';
      newCategoryInput.focus();
    } else {
      newCategoryInput.style.display = 'none';
    }
  });

  // Handle task form submission
  document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const task = document.getElementById('taskInput').value;
    const select = document.getElementById('categorySelect');
    let category = select.value;
    
    if (category === '__custom__') {
      category = document.getElementById('newCategoryInput').value.trim();
      if (!category) {
        alert('Please enter a category name');
        return;
      }
    } else if (!category) {
      alert('Please select or create a category');
      return;
    }

    const messageEl = document.getElementById('taskMessage');

    try {
  const token = localStorage.getItem('token');
  const ownerId = categoryOwners[category]; // Get owner ID for shared folders
  const response = await fetch('/api/tasks', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ task, category, ownerId })
  });

      if (response.ok) {
        document.getElementById('taskInput').value = '';
        document.getElementById('newCategoryInput').value = '';
        select.value = '';
        loadTasks();
      } else {
        const result = await response.json();
        messageEl.textContent = result.message || 'Error adding task';
        messageEl.style.color = 'red';
      }
    } catch (error) {
      console.error('Error adding task:', error);
      messageEl.textContent = 'Network error: ' + error.message;
      messageEl.style.color = 'red';
    }
  });

// Toggle task completion
async function toggleTask(taskId) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/tasks/${taskId}/toggle`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      loadTasks();
    } else {
      alert('Task marked as done');
    }
  } catch (error) {
    console.error('Error toggling task:', error);
    alert('Error updating task');
  }
}




  // Delete task
  async function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/tasks/${taskId}/delete`, {
          method: 'POST', 
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadTasks();
        } else {
          alert('Failed to delete task');
        }
      } catch (error) {
        console.error('Error deleting task:', error);
        alert('Error deleting task');
      }
    }
  }

  // Check login status on page load
  checkUserLogin();

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('shareModal');
    if (event.target == modal) {
      closeShareModal();
    }
  }
</script>

</body>
</html>
